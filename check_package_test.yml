---
- hosts: all

  vars:
    ansible_python_interpreter: auto_legacy_silent

  vars_prompt:
    - name: package_name
      prompt: Enter the Package name
      private: no

  tasks:

    - name: extract package version
      shell:
        cmd: echo '{{ package_name }}' | egrep -o '[0-9].*-[0-9]'
      register: package_version
    
    - set_fact:
        package_ver: "{{ package_version | regex_replace('\\.', '') | regex_replace('\\-', '') }}"
        
    - name: "Check if package is installed or not"
      shell: 
        cmd: rpm -qa | grep "{{ package_name }}" | egrep -o '[0-9].*-[0-9]'
        warn: false
      register: package_check
      changed_when: false 
      failed_when: false
    
    - set_fact:
        package_chk: "{{ package_check | regex_replace('\\.', '') | regex_replace('\\-', '') }}"

    - name: "Print execution results when same package version installed"
      debug:
        msg: "Package {{ package_name }} is installed"
      when: package_ver.stdout == package_chk.stdout
    
    - name: "Print execution results when package version not matched/installed"
      debug:
        msg: "Package {{ package_name }} is not installed"
      when: package_chk.stdout == ""
       
    - name: "Create list of hosts with package not matched/installed"
      lineinfile:
        line: "{{ item }}"
        dest: ./hostlist
        create: true
      delegate_to: localhost
      loop: "{{ groups.all }}"
      when: package_chk.stdout == ""