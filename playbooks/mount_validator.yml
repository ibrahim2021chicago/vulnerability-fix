---

- hosts: all

  vars:
    ansible_python_interpreter: auto_legacy_silent
    mount_list_before: "/tmp/mount_before_{{ inventory_hostname }}_{{ ansible_date_time.date }}.txt"
    mount_list_after: "/tmp/mount_after_{{ inventory_hostname }}_{{ ansible_date_time.date }}.txt"
    mount_list_compare: "./reports/mount_{{ inventory_hostname }}_{{ ansible_date_time.date }}.txt"

  tasks:

    - name: Retrieve list of mounts before patching
      shell:
        cmd: df -Th |
            grep -v tmpfs |
            awk '{print $1" "$2" "$7}' |
            column -t
        warn: false
      register: mount_before

    - name: Create list of mounts before patching
      copy:
        dest: "{{ mount_list_before }}"
        content: "{{ mount_before.stdout_lines | join('\n') }}"

    - name: Patching servers
      yum:
        name: '*'
        state: latest

    - name: Reboot the servers
      reboot:
        reboot_timeout: 300
        test_command: uptime

    - name: Retrieve list of mounts after patching
      shell:
        cmd: df -Th |
            grep -v tmpfs |
            awk '{print $1" "$2" "$7}' |
            column -t
        warn: false
      register: mount_after
    
    - name: Create list of mounts after patching
      copy:
        dest: "{{ mount_list_after }}"
        content: "{{ mount_after.stdout_lines | join('\n') }}"

    - name: Compare mounts before and after patching
      shell:
        cmd: diff "{{ mount_list_after }}" "{{ mount_list_before }}" |
            grep -v "^---" |
            grep -v "^[0-9c0-9]"
      register: mount_diff
      changed_when: mount_diff != ""
      failed_when: false

    - name: Generate mount comparison list
      copy:
        dest: "{{ mount_list_compare }}"
        content: "{{ mount_diff.stdout_lines | join('\n') }}"
      delegate_to: localhost
      when: mount_before.stdout_lines != mount_after.stdout_lines